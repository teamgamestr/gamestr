const y=(e,t)=>t.some(n=>e instanceof n);let b,E;function C(){return b||(b=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function O(){return E||(E=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const D=new WeakMap,w=new WeakMap,h=new WeakMap;function T(e){const t=new Promise((n,r)=>{const i=()=>{e.removeEventListener("success",c),e.removeEventListener("error",o)},c=()=>{n(d(e.result)),i()},o=()=>{r(e.error),i()};e.addEventListener("success",c),e.addEventListener("error",o)});return h.set(t,e),t}function j(e){if(D.has(e))return;const t=new Promise((n,r)=>{const i=()=>{e.removeEventListener("complete",c),e.removeEventListener("error",o),e.removeEventListener("abort",o)},c=()=>{n(),i()},o=()=>{r(e.error||new DOMException("AbortError","AbortError")),i()};e.addEventListener("complete",c),e.addEventListener("error",o),e.addEventListener("abort",o)});D.set(e,t)}let l={get(e,t,n){if(e instanceof IDBTransaction){if(t==="done")return D.get(e);if(t==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return d(e[t])},set(e,t,n){return e[t]=n,!0},has(e,t){return e instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in e}};function x(e){l=e(l)}function p(e){return O().includes(e)?function(...t){return e.apply(I(this),t),d(this.request)}:function(...t){return d(e.apply(I(this),t))}}function A(e){return typeof e=="function"?p(e):(e instanceof IDBTransaction&&j(e),y(e,C())?new Proxy(e,l):e)}function d(e){if(e instanceof IDBRequest)return T(e);if(w.has(e))return w.get(e);const t=A(e);return t!==e&&(w.set(e,t),h.set(t,e)),t}const I=e=>h.get(e);function V(e,t,{blocked:n,upgrade:r,blocking:i,terminated:c}={}){const o=indexedDB.open(e,t),u=d(o);return r&&o.addEventListener("upgradeneeded",s=>{r(d(o.result),s.oldVersion,s.newVersion,d(o.transaction),s)}),n&&o.addEventListener("blocked",s=>n(s.oldVersion,s.newVersion,s)),u.then(s=>{c&&s.addEventListener("close",()=>c()),i&&s.addEventListener("versionchange",a=>i(a.oldVersion,a.newVersion,a))}).catch(()=>{}),u}const N=["get","getKey","getAll","getAllKeys","count"],v=["put","add","delete","clear"],m=new Map;function M(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t=="string"))return;if(m.get(t))return m.get(t);const n=t.replace(/FromIndex$/,""),r=t!==n,i=v.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!(i||N.includes(n)))return;const c=async function(o,...u){const s=this.transaction(o,i?"readwrite":"readonly");let a=s.store;return r&&(a=a.index(u.shift())),(await Promise.all([a[n](...u),i&&s.done]))[0]};return m.set(t,c),c}x(e=>({...e,get:(t,n,r)=>M(t,n)||e.get(t,n,r),has:(t,n)=>!!M(t,n)||e.has(t,n)}));const F=["continue","continuePrimaryKey","advance"],P={},B=new WeakMap,L=new WeakMap,W={get(e,t){if(!F.includes(t))return e[t];let n=P[t];return n||(n=P[t]=function(...r){B.set(this,L.get(this)[t](...r))}),n}};async function*R(...e){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...e)),!t)return;t=t;const n=new Proxy(t,W);for(L.set(n,t),h.set(n,I(t));t;)yield n,t=await(B.get(n)||t.continue()),B.delete(n)}function S(e,t){return t===Symbol.asyncIterator&&y(e,[IDBIndex,IDBObjectStore,IDBCursor])||t==="iterate"&&y(e,[IDBIndex,IDBObjectStore])}x(e=>({...e,get(t,n,r){return S(t,n)?R:e.get(t,n,r)},has(t,n){return S(t,n)||e.has(t,n)}}));const k=()=>`nostr-dm-store-${typeof window<"u"?window.location.hostname:"default"}`,K=k(),_=1,f="messages";async function g(){return V(K,_,{upgrade(e){e.objectStoreNames.contains(f)||e.createObjectStore(f)}})}async function $(e,t){try{await(await g()).put(f,t,e)}catch(n){throw console.error("[MessageStore] âŒ Error writing to IndexedDB:",n),n}}async function z(e){try{const n=await(await g()).get(f,e);return n||void 0}catch(t){throw console.error("[MessageStore] Error reading from IndexedDB:",t),t}}async function G(e){try{await(await g()).delete(f,e)}catch(t){throw console.error("[MessageStore] Error deleting from IndexedDB:",t),t}}export{G as deleteMessagesFromDB,z as readMessagesFromDB,$ as writeMessagesToDB};
