{
  "version": 3,
  "sources": ["../../@nostrify/nostrify/dist/uploaders/BlossomUploader.js", "../../@nostrify/nostrify/dist/uploaders/NostrBuildUploader.js"],
  "sourcesContent": ["import { encodeHex } from \"@std/encoding/hex\";\nimport { z } from \"zod\";\nimport { N64 } from \"../utils/N64.js\";\nclass BlossomUploader {\n  servers;\n  signer;\n  fetch;\n  expiresIn;\n  constructor(opts) {\n    this.servers = opts.servers;\n    this.signer = opts.signer;\n    this.fetch = opts.fetch ?? globalThis.fetch.bind(globalThis);\n    this.expiresIn = opts.expiresIn ?? 6e4;\n  }\n  async upload(file, opts) {\n    const x = encodeHex(\n      await crypto.subtle.digest(\"SHA-256\", await file.arrayBuffer())\n    );\n    const now = Date.now();\n    const expiration = now + this.expiresIn;\n    const event = await this.signer.signEvent({\n      kind: 24242,\n      content: `Upload ${file.name}`,\n      created_at: Math.floor(now / 1e3),\n      tags: [\n        [\"t\", \"upload\"],\n        [\"x\", x],\n        [\"size\", file.size.toString()],\n        [\"expiration\", Math.floor(expiration / 1e3).toString()]\n      ]\n    });\n    const authorization = `Nostr ${N64.encodeEvent(event)}`;\n    return Promise.any(this.servers.map(async (server) => {\n      const url = new URL(\"/upload\", server);\n      const response = await this.fetch(url, {\n        method: \"PUT\",\n        body: file,\n        headers: {\n          authorization,\n          \"content-type\": file.type\n        },\n        signal: opts?.signal\n      });\n      const json = await response.json();\n      const data = BlossomUploader.schema().parse(json);\n      const tags = [\n        [\"url\", data.url],\n        [\"x\", data.sha256],\n        [\"ox\", data.sha256],\n        [\"size\", data.size.toString()]\n      ];\n      if (data.type) {\n        tags.push([\"m\", data.type]);\n      }\n      return tags;\n    }));\n  }\n  /** Blossom \"BlobDescriptor\" schema. */\n  static schema() {\n    return z.object({\n      url: z.string(),\n      sha256: z.string(),\n      size: z.number(),\n      type: z.string().optional()\n    });\n  }\n}\nexport {\n  BlossomUploader\n};\n", "import { z } from \"zod\";\nimport { N64 } from \"../utils/N64.js\";\nimport { NIP98 } from \"../NIP98.js\";\nclass NostrBuildUploader {\n  endpoint;\n  signer;\n  fetch;\n  constructor(opts) {\n    this.endpoint = opts?.endpoint ?? \"https://nostr.build/api/v2/upload/files\";\n    this.signer = opts?.signer;\n    this.fetch = opts?.fetch ?? globalThis.fetch.bind(globalThis);\n  }\n  async upload(file, opts) {\n    const formData = new FormData();\n    formData.append(\"fileToUpload\", file);\n    const request = new Request(this.endpoint, {\n      method: \"POST\",\n      body: formData,\n      signal: opts?.signal\n    });\n    if (this.signer) {\n      const t = await NIP98.template(request);\n      const event = await this.signer.signEvent(t);\n      request.headers.set(\"authorization\", `Nostr ${N64.encodeEvent(event)}`);\n    }\n    const response = await this.fetch(request);\n    const json = await response.json();\n    console.log(json);\n    const [data] = NostrBuildUploader.schema().parse(json).data;\n    const tags = [\n      [\"url\", data.url],\n      [\"m\", data.mime],\n      [\"x\", data.sha256],\n      [\"ox\", data.original_sha256],\n      [\"size\", data.size.toString()]\n    ];\n    if (data.dimensions) {\n      tags.push([\"dim\", `${data.dimensions.width}x${data.dimensions.height}`]);\n    }\n    if (data.blurhash) {\n      tags.push([\"blurhash\", data.blurhash]);\n    }\n    return tags;\n  }\n  /** nostr.build API response schema. */\n  static schema() {\n    return z.object({\n      data: z.object({\n        url: z.string().url(),\n        blurhash: z.string().optional().catch(void 0),\n        sha256: z.string(),\n        original_sha256: z.string(),\n        mime: z.string(),\n        size: z.number(),\n        dimensions: z.object({\n          width: z.number().positive(),\n          height: z.number().positive()\n        }).optional().catch(void 0)\n      }).array().min(1)\n    });\n  }\n}\nexport {\n  NostrBuildUploader\n};\n"],
  "mappings": "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",
  "names": []
}
