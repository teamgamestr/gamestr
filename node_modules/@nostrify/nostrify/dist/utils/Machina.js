class Machina {
  #queue = [];
  #resolve;
  #aborted = false;
  constructor(signal) {
    if (signal?.aborted) {
      this.abort();
    } else {
      signal?.addEventListener("abort", () => this.abort(), { once: true });
    }
  }
  /** Get messages as an AsyncIterable. */
  async *[Symbol.asyncIterator]() {
    while (!this.#aborted) {
      if (this.#queue.length) {
        yield this.#queue.shift();
        continue;
      }
      await new Promise((_resolve) => {
        this.#resolve = _resolve;
      });
    }
    throw new DOMException("The signal has been aborted", "AbortError");
  }
  /** Push a message into the Machina instance, making it available to the consumer of `stream()`. */
  push(data) {
    this.#queue.push(data);
    this.#resolve?.();
  }
  /** Stops streaming and throws an error to the consumer. */
  abort() {
    this.#aborted = true;
    this.#resolve?.();
  }
}
export {
  Machina
};
